<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hunger Heatmap</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; }
    header { background:#2575fc; color:white; padding:12px 16px; display:flex; justify-content:space-between; align-items:center; }
    #map { height:72vh; width:100%; }
    #qrModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; }
    #qrContent { background:white; padding:20px; border-radius:8px; text-align:center; }
    #qrImage { margin-bottom:15px; }
  </style>
</head>
<body>
  <header>
    <div><strong>Hunger Heatmap</strong> - Welcome, {{ user }}</div>
    <div>
      <a class="btn btn-light btn-sm" href="/piechart" target="_blank">View Hunger Statistics</a>
      <a class="btn btn-outline-light btn-sm" href="/logout">Logout</a>
    </div>
  </header>

  <div id="map"></div>

  <!-- QR Modal -->
  <div id="qrModal" onclick="if(event.target==this) this.style.display='none'">
    <div id="qrContent">
      <img id="qrImage" src="" alt="QR Code">
      <br>
      <a id="verifyBtn" href="/verify" class="btn btn-success btn-sm mt-2" target="_blank">Verify QR Code</a>
    </div>
  </div>

  <script>
    const markers = {{ markers | tojson }};
    function initMap() {
      const map = new google.maps.Map(document.getElementById('map'), { zoom:7, center: { lat:11.1271, lng:78.6569 } });
      markers.forEach(zone => {
        const circle = new google.maps.Circle({
          strokeColor: zone.color,
          strokeOpacity: 0.8,
          strokeWeight: 1,
          fillColor: zone.color,
          fillOpacity: 0.6,
          map: map,
          center: { lat: zone.lat, lng: zone.lng },
          radius: 15000
        });
        circle.addListener('click', () => {
          if (zone.color === 'red') {
            fetch('/generate_qr', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ region: zone.region, month: zone.month }) })
              .then(res => res.blob())
              .then(blob => {
                document.getElementById('qrImage').src = URL.createObjectURL(blob);
                document.getElementById('qrModal').style.display = 'flex';
              });
          } else {
            alert('This zone is not in severe category (red).');
          }
        });
      });
    }
  </script>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAQyfLpamuxnlbsJIs9EU-5DHlCGHkcy-g&callback=initMap" async defer></script>
</body>
</html>
